## ADDED Requirements

### Requirement: AI ticket generation
The system SHALL generate 35–40 code tickets when a game room is created. Tickets MUST be generated by calling an LLM API (OpenAI, Anthropic, or Gemini) with a structured prompt. The generation MUST complete within 20 seconds. Generated tickets SHALL be stored as JSONB in the `game_rooms.tickets` column.

#### Scenario: Successful generation for PHP topic
- **WHEN** room is created with topic "PHP"
- **THEN** system generates 35–40 tickets containing PHP code challenges (syntax errors, Laravel logic, Eloquent queries, array functions) across easy, medium, and hard difficulties

#### Scenario: Successful generation for Frontend topic
- **WHEN** room is created with topic "Frontend"
- **THEN** system generates 35–40 tickets containing Frontend code challenges (CSS bugs, JavaScript gotchas, React/Vue patterns, HTML semantics) across easy, medium, and hard difficulties

#### Scenario: Successful generation for Mix topic
- **WHEN** room is created with topic "Mix"
- **THEN** system generates 35–40 tickets with approximately half PHP and half Frontend challenges

#### Scenario: AI generation timeout
- **WHEN** AI provider does not respond within 20 seconds
- **THEN** system falls back to preset ticket bank for the selected topic

#### Scenario: AI returns invalid ticket format
- **WHEN** AI response cannot be parsed into valid ticket structures
- **THEN** system falls back to preset ticket bank for the selected topic

### Requirement: AI provider abstraction
The system SHALL support multiple AI providers through an abstraction layer. The active provider SHALL be determined by an environment variable `AI_PROVIDER`. Supported providers: `openai`, `anthropic`, `gemini`.

#### Scenario: Switch AI provider
- **WHEN** environment variable `AI_PROVIDER` is set to "anthropic"
- **THEN** system uses Anthropic Claude API for ticket generation

#### Scenario: Missing API key
- **WHEN** the configured provider's API key is not set in environment variables
- **THEN** system falls back to preset ticket bank and logs a warning

### Requirement: Ticket structure
Each ticket MUST contain: an `id` (string), `type` (enum: multiple-choice, fill-in-blank, drag-and-drop), `difficulty` (enum: easy, medium, hard), `language` (enum: php, javascript, css, html), `code` (string with the code snippet), `question` (string), `options` (array for multiple-choice), `correct_answer` (string or array), and `points` (integer: 5, 8, or 12 based on difficulty).

#### Scenario: Easy multiple-choice ticket
- **WHEN** a ticket of type "multiple-choice" and difficulty "easy" is generated
- **THEN** ticket contains a code snippet with a bug, a question, 4 answer options (exactly 1 correct), and points value of 5

#### Scenario: Medium fill-in-blank ticket
- **WHEN** a ticket of type "fill-in-blank" and difficulty "medium" is generated
- **THEN** ticket contains a code snippet with a blank placeholder, a question, the correct answer string, and points value of 8

#### Scenario: Hard drag-and-drop ticket
- **WHEN** a ticket of type "drag-and-drop" and difficulty "hard" is generated
- **THEN** ticket contains shuffled code lines, the correct ordering, and points value of 12

### Requirement: Ticket distribution per difficulty
The system SHALL generate tickets with a balanced distribution: approximately 40% easy, 35% medium, and 25% hard. Each player SHALL receive tickets in a shuffled order unique to them.

#### Scenario: Difficulty distribution
- **WHEN** 36 tickets are generated
- **THEN** approximately 14–15 are easy, 12–13 are medium, and 9–10 are hard

#### Scenario: Per-player shuffle
- **WHEN** two players start the same game
- **THEN** each player receives the same ticket pool but in a different randomized order

### Requirement: Answer validation
The system SHALL validate player answers client-side. For multiple-choice, the selected option MUST match the `correct_answer`. For fill-in-blank, the typed answer MUST match after trimming whitespace and normalizing case. For drag-and-drop, the ordered array MUST match exactly.

#### Scenario: Correct multiple-choice answer
- **WHEN** player selects option "B" and correct_answer is "B"
- **THEN** answer is marked correct and player progress increases by the ticket's point value

#### Scenario: Incorrect fill-in-blank answer
- **WHEN** player types "foreach" and correct_answer is "array_map"
- **THEN** answer is marked incorrect, progress does not increase, and streak resets

#### Scenario: Case-insensitive fill-in-blank
- **WHEN** player types "Array_Map" and correct_answer is "array_map"
- **THEN** answer is marked correct (case-insensitive comparison)

### Requirement: Conflict challenge generation
The system SHALL include conflict challenges in the generated ticket set. Conflict challenges are of two types: "hard_puzzle" (a harder-than-normal code question) and "silly_task" (a typing challenge requiring exact reproduction of a long comment string).

#### Scenario: Hard puzzle conflict
- **WHEN** a player is hit with a conflict of type "hard_puzzle"
- **THEN** system presents a code challenge with difficulty higher than the player's current ticket difficulty

#### Scenario: Silly task conflict
- **WHEN** a player is hit with a conflict of type "silly_task"
- **THEN** system presents a long code comment string that the player MUST type exactly to resolve
